- name: Skip disable when sbm_dry_run enabled
  ansible.builtin.debug:
    msg: "Dry run enabled; skipping API-based disable."
  when: sbm_dry_run | default(false) | bool

- when: not sbm_dry_run | default(false) | bool
  block:
    - name: Check if user exists via SOAP API
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}:{{ sbm_port | default('9443') }}/ServerBackupManager/api"
        method: POST
        body_format: raw
        body: |
          <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://www.r1soft.com/webservices/">
            <soapenv:Header/>
            <soapenv:Body>
              <ser:FindUserByName>
                <ser:username>{{ sbm_target_user.username }}</ser:username>
              </ser:FindUserByName>
            </soapenv:Body>
          </soapenv:Envelope>
        headers:
          Content-Type: text/xml;charset=UTF-8
          SOAPAction: "FindUserByName"
        user: "{{ sbm_admin_user }}"
        password: "{{ sbm_admin_pass }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
        status_code: [200, 500]
        timeout: 20
      register: sbm_api_direct_user_lookup
      changed_when: false

    - name: Determine if user is already disabled or missing
      ansible.builtin.set_fact:
        sbm_api_direct_user_missing: "{{ 'FindUserByNameResponse' not in (sbm_api_direct_user_lookup.content | default('')) }}"
      changed_when: false

    - name: Emit idempotent message when user missing
      ansible.builtin.debug:
        msg: "Already disabled"
      when: sbm_api_direct_user_missing | bool

    - name: Disable Power-User via SOAP
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}:{{ sbm_port | default('9443') }}/ServerBackupManager/api"
        method: POST
        body_format: raw
        body: |
          <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://www.r1soft.com/webservices/">
            <soapenv:Header/>
            <soapenv:Body>
              <ser:DisablePowerUser>
                <ser:username>{{ sbm_target_user.username }}</ser:username>
              </ser:DisablePowerUser>
            </soapenv:Body>
          </soapenv:Envelope>
        headers:
          Content-Type: text/xml;charset=UTF-8
          SOAPAction: "DisablePowerUser"
        user: "{{ sbm_admin_user }}"
        password: "{{ sbm_admin_pass }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
        status_code: [200]
        timeout: 20
      register: sbm_api_direct_disable
      changed_when: true
      failed_when: "'Fault' in (sbm_api_direct_disable.content | default(''))"
      when: not sbm_api_direct_user_missing | bool

    - name: Emit success message when disabled
      ansible.builtin.debug:
        msg: "Disabled"
      when: not sbm_api_direct_user_missing | bool

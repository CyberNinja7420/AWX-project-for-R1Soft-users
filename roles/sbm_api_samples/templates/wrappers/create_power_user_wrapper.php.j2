<?php
// Wrapper that sets variables then includes the vendor's tested sample.
// Linux vendor path: /usr/sbin/r1soft/apisamples

$HOST = "{{ ansible_host }}";
$PORT = "{{ sbm_port | default('9443') }}";
$USER = "{{ sbm_admin_user }}";
$PASS = "{{ sbm_admin_pass }}";

// Target user
$TARGET_USERNAME = "{{ sbm_target_user.username }}";
$TARGET_PASSWORD = "{{ sbm_target_user.password }}";
$TARGET_EMAIL    = "{{ sbm_target_user.email }}";
$TARGET_FULLNAME = "{{ sbm_target_user.full_name }}";
$ALLOW_SUBUSERS  = {{ 'true' if sbm_target_user.allow_subusers else 'false' }};

// Some vendor samples expect a volume to exist/assign
$VOLUME_NAME = "{{ volume_name }}";
$VOLUME_PATH = "{{ volume_path }}";
$SOFT_QUOTA  = {{ quota_soft | int }};
$HARD_QUOTA  = {{ quota_hard | int }};

$alreadyExists = false;
try {
  $contextOptions = array(
    'ssl' => array(
      'verify_peer' => false,
      'verify_peer_name' => false,
    )
  );
  $client = @new SoapClient(
    "https://{$HOST}:{$PORT}/ServerBackupManager/api?wsdl",
    array(
      'login' => $USER,
      'password' => $PASS,
      'trace' => 0,
      'exceptions' => 1,
      'cache_wsdl' => WSDL_CACHE_NONE,
      'stream_context' => stream_context_create($contextOptions)
    )
  );
  $result = $client->__soapCall('FindUserByName', array(array('username' => $TARGET_USERNAME)));
  if ($result) {
    $alreadyExists = true;
  }
} catch (Exception $e) {
  // Continue to create path when user lookup fails.
}

if ($alreadyExists) {
  echo "Already exists\n";
  exit(0);
}

$candidates = [
  '/usr/sbin/r1soft/apisamples/Volumes_With_Limits_Power_User_With_Sub_User_Allowed.php',
  '/usr/sbin/r1soft/apisamples/Create_Volume_Power_User_With_SubUsers.php',
  '/usr/sbin/r1soft/apisamples/CreateVolumeAndPowerUser.php'
];

$ok = false;
foreach ($candidates as $f) {
  if (file_exists($f)) {
    include($f);
    $ok = true;
    break;
  }
}

if (!$ok) {
  fwrite(STDERR, "No vendor sample found for Power-User creation\n");
  exit(1);
}

echo "Successfully created power user\n";

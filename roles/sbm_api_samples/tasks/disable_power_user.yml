- name: Skip disable when sbm_dry_run enabled
  ansible.builtin.debug:
    msg: "Dry run enabled; skipping disable."
  when: sbm_dry_run | default(false) | bool

- when: not sbm_dry_run | default(false) | bool
  block:
    - name: Deploy wrapper to include vendor sample for disable
      ansible.builtin.template:
        src: wrappers/disable_power_user_wrapper.php.j2
        dest: /root/awx-sbm-disable-power-user.php
        mode: "0700"
      become: true

    - name: Execute disable wrapper
      ansible.builtin.command: php /root/awx-sbm-disable-power-user.php
      register: disable_out
      changed_when: >
        ('disabled' in (disable_out.stdout | lower))
        or ('successfully disabled' in (disable_out.stdout | lower))
      failed_when: "disable_out.rc != 0 and 'already disabled' not in (disable_out.stdout | lower) and 'no user found' not in (disable_out.stdout | lower)"
      become: true

    - name: Show disable output
      ansible.builtin.debug:
        var: disable_out.stdout_lines

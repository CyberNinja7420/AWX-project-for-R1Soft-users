- name: Skip disable when sbm_dry_run enabled
  ansible.builtin.debug:
    msg: "Dry run enabled; skipping disable."
  when: sbm_dry_run | default(false) | bool

- name: Disable power user when not in dry-run
  when: not sbm_dry_run | default(false) | bool
  block:
    - name: Deploy wrapper to include vendor sample for disable
      ansible.builtin.template:
        src: wrappers/disable_power_user_wrapper.php.j2
        dest: /root/awx-sbm-disable-power-user.php
        mode: "0700"
      become: true

    - name: Execute disable wrapper
      ansible.builtin.command: php /root/awx-sbm-disable-power-user.php
      register: sbm_api_samples_disable_out
      changed_when: >
        ('disabled' in (sbm_api_samples_disable_out.stdout | lower))
        or ('successfully disabled' in (sbm_api_samples_disable_out.stdout | lower))
      failed_when: >-
        sbm_api_samples_disable_out.rc != 0
        and 'already disabled' not in (sbm_api_samples_disable_out.stdout | lower)
        and 'no user found' not in (sbm_api_samples_disable_out.stdout | lower)
      become: true

    - name: Show disable output
      ansible.builtin.debug:
        var: sbm_api_samples_disable_out.stdout_lines

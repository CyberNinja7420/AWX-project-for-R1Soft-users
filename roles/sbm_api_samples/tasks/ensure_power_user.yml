- name: Skip create when sbm_dry_run enabled
  ansible.builtin.debug:
    msg: "Dry run enabled; skipping user create/ensure."
  when: sbm_dry_run | default(false) | bool

- when: not sbm_dry_run | default(false) | bool
  block:
    - name: Deploy wrapper to include vendor sample for create/ensure
      ansible.builtin.template:
        src: wrappers/create_power_user_wrapper.php.j2
        dest: /root/awx-sbm-create-power-user.php
        mode: "0700"
      become: true

    - name: Execute create/ensure wrapper
      ansible.builtin.command: php /root/awx-sbm-create-power-user.php
      register: sbm_api_samples_create_out
      changed_when: "'successfully created power user' in (sbm_api_samples_create_out.stdout | lower)"
      failed_when: "sbm_api_samples_create_out.rc != 0 and 'already exists' not in (sbm_api_samples_create_out.stdout | lower)"
      become: true

    - name: Show create output
      ansible.builtin.debug:
        var: sbm_api_samples_create_out.stdout_lines

- name: Skip create when sbm_dry_run enabled
  ansible.builtin.debug:
    msg: "Dry run enabled; skipping user create/ensure."
  when: sbm_dry_run | default(false) | bool

- when: not sbm_dry_run | default(false) | bool
  block:
    - name: Deploy wrapper to include vendor sample for create/ensure
      ansible.builtin.template:
        src: wrappers/create_power_user_wrapper.php.j2
        dest: /root/awx-sbm-create-power-user.php
        mode: "0700"
      become: true

    - name: Execute create/ensure wrapper
      ansible.builtin.command: php /root/awx-sbm-create-power-user.php
      register: create_out
      changed_when: "'Successfully created power user' in create_out.stdout"
      failed_when: >
        create_out.rc != 0
        and ('already exists' not in (create_out.stdout | lower))
        and ('Already exists' not in create_out.stdout)
      become: true

    - name: Show create output
      ansible.builtin.debug:
        var: create_out.stdout_lines

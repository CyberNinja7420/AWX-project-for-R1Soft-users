---
- name: Build in-memory inventory from CSV and scan
  hosts: localhost
  gather_facts: false
  strategy: linear
  vars:
    csv_path: "data/sbms.csv"
  tasks:
    - name: Read CSV
      community.general.read_csv:
        path: "{{ csv_path }}"
      register: rows

    - name: Add hosts to in-memory inventory group "sbms"
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        groups: "sbms"
        sbm_host: "{{ item.host }}"
        sbm_port: "{{ item.port | default('9443') }}"
        site: "{{ item.site | default('') }}"
        env: "{{ item.env | default('') }}"
        sbm_api_user: "{{ item.api_user | default('') }}"
        sbm_api_pass: "{{ hostvars.localhost[item.api_pass_var] | default('') }}"
      loop: "{{ rows.list }}"

- name: Scan all CSV-provided SBMs
  hosts: sbms
  gather_facts: false
  strategy: linear
  roles:
    - sbm_scan
  post_tasks:
    - name: Ensure reports directory (controller)
      ansible.builtin.file:
        path: reports
        state: directory
        mode: "0755"
      run_once: true
      delegate_to: localhost
    - name: Set report timestamp (controller)
      ansible.builtin.set_fact:
        report_ts: "{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"
      run_once: true
      delegate_to: localhost
      delegate_facts: true
    - name: Emit JSON report
      ansible.builtin.template:
        src: "report.json.j2"
        dest: "reports/sbm_scan_{{ report_ts }}.json"
        mode: "0644"
      run_once: true
      delegate_to: localhost
    - name: Publish JSON report artifact (AWX controller)
      ansible.builtin.set_stats:
        data:
          artifacts:
            sbm_scan_json: "reports/sbm_scan_{{ report_ts }}.json"
      run_once: true
      delegate_to: localhost
    - name: Emit Markdown report
      ansible.builtin.template:
        src: "report.md.j2"
        dest: "reports/sbm_scan_{{ report_ts }}.md"
        mode: "0644"
      run_once: true
      delegate_to: localhost

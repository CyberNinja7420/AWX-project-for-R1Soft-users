---
- name: Bootstrap AWX objects for sbm-user-admin
  hosts: localhost
  gather_facts: false
  vars:
    awx_org: "Default"
    awx_inventory: "R1Soft-SBMs"
    awx_project: "sbm-user-admin"
    awx_credential: "SBM API (survey-driven)"
    project_repo_url: ""
  tasks:
    - name: Require controller details and repo URL
      ansible.builtin.assert:
        that:
          - awx_host is defined and awx_host | length > 0
          - awx_token is defined and awx_token | length > 0
          - project_repo_url | length > 0
        fail_msg: "awx_host, awx_token, and project_repo_url are required (pass via -e)."

    - name: Ensure Project
      awx.awx.project:
        name: "{{ awx_project }}"
        organization: "{{ awx_org }}"
        scm_type: git
        scm_url: "{{ project_repo_url }}"
        scm_branch: main
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Ensure Inventory
      awx.awx.inventory:
        name: "{{ awx_inventory }}"
        organization: "{{ awx_org }}"
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Create placeholder credential (no secrets stored)
      awx.awx.credential:
        name: "{{ awx_credential }}"
        organization: "{{ awx_org }}"
        credential_type: Machine
        inputs: {}
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Load surveys
      set_fact:
        survey_scan: "{{ lookup('file','awx/surveys/sbm_scan.survey.json') | from_json }}"
        survey_create: "{{ lookup('file','awx/surveys/create_user.survey.json') | from_json }}"
        survey_disable: "{{ lookup('file','awx/surveys/disable_user.survey.json') | from_json }}"

    - name: Ensure JT - Inventory Scan & Report (Inventory)
      awx.awx.job_template:
        name: "SBM – Inventory Scan & Report (Inventory)"
        job_type: run
        use_fact_cache: false
        inventory: "{{ awx_inventory }}"
        project: "{{ awx_project }}"
        playbook: "playbooks/sbm_scan.yml"
        survey_enabled: true
        survey_spec: "{{ survey_scan }}"
        verbosity: 1
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Ensure JT - Inventory Scan & Report (CSV)
      awx.awx.job_template:
        name: "SBM – Inventory Scan & Report (CSV)"
        job_type: run
        use_fact_cache: false
        inventory: "{{ awx_inventory }}"
        project: "{{ awx_project }}"
        playbook: "playbooks/sbm_scan_from_csv.yml"
        survey_enabled: true
        survey_spec: "{{ survey_scan }}"
        verbosity: 1
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Ensure JT - Create/Ensure Power-User
      awx.awx.job_template:
        name: "SBM – Create/Ensure Power-User"
        job_type: run
        use_fact_cache: false
        inventory: "{{ awx_inventory }}"
        project: "{{ awx_project }}"
        playbook: "playbooks/sbm_user_create.yml"
        survey_enabled: true
        survey_spec: "{{ survey_create }}"
        verbosity: 1
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false

    - name: Ensure JT - Disable Power-User
      awx.awx.job_template:
        name: "SBM – Disable Power-User"
        job_type: run
        use_fact_cache: false
        inventory: "{{ awx_inventory }}"
        project: "{{ awx_project }}"
        playbook: "playbooks/sbm_user_disable.yml"
        survey_enabled: true
        survey_spec: "{{ survey_disable }}"
        verbosity: 1
        controller_host: "{{ awx_host }}"
        controller_oauthtoken: "{{ awx_token }}"
        validate_certs: false
